version: 1
applications:
  - appRoot: frontend
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            # Optional:
            # Deploy/update the Amplify Gen 2 backend during CI and generate amplify_outputs.json.
            #
            # IMPORTANT: If you let Hosting use AWS_APP_ID/AWS_BRANCH, it will create a NEW backend env
            # (and thus a NEW Cognito User Pool) for this hosting app/branch.
            #
            # To keep web using an existing "shared" backend (same Cognito pool as mobile), either:
            # - leave AMPLIFY_DEPLOY_BACKEND unset/false (web uses committed outputs), OR
            # - set AMPLIFY_DEPLOY_BACKEND=true and set AMPX_APP_ID/AMPX_BRANCH to the backend you want.
            - |
              if [ "${AMPLIFY_DEPLOY_BACKEND:-false}" = "true" ]; then
                APP_ID="${AMPX_APP_ID:-${AWS_APP_ID:-}}"
                BRANCH="${AMPX_BRANCH:-${AWS_BRANCH:-}}"
                if [ -n "$APP_ID" ] && [ -n "$BRANCH" ]; then
                  npx ampx pipeline-deploy --app-id "$APP_ID" --branch "$BRANCH"
                else
                  echo "Skipping backend deploy (missing APP_ID/BRANCH). Set AMPX_APP_ID and AMPX_BRANCH."
                fi
              else
                echo "Skipping backend deploy (AMPLIFY_DEPLOY_BACKEND is false)"
              fi
        build:
          commands:
            - npm run build:web
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*

